<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticketon</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #0a0a0a;
            --white: #f5f0e8;
            --accent: #ff4d00;
            --accent2: #00e5ff;
            --gray: #1a1a1a;
            --gray2: #2a2a2a;
            --green: #00ff88;
            --yellow: #ffe600;
            --red: #ff2244;
            --muted: #555;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--black);
            color: var(--white);
            font-family: 'Syne', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ NOISE OVERLAY ‚îÄ‚îÄ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 9999;
            opacity: 0.4;
        }

        /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
        #pantalla-login {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: 
                radial-gradient(ellipse 60% 50% at 80% 20%, rgba(255,77,0,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at 10% 80%, rgba(0,229,255,0.08) 0%, transparent 60%),
                var(--black);
        }

        .login-box {
            width: 100%;
            max-width: 420px;
            border: 1px solid #222;
            background: var(--gray);
            padding: 2.5rem;
            position: relative;
            animation: slideUp 0.5s ease;
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .logo-mark {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .logo-icon {
            width: 44px; height: 44px;
            background: var(--accent);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .logo-sub {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        label {
            display: block;
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 0.5rem;
        }

        input[type=text], input[type=password], input[type=number], select {
            width: 100%;
            background: var(--black);
            border: 1px solid #333;
            color: var(--white);
            padding: 0.75rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        input:focus, select:focus {
            border-color: var(--accent);
        }

        select option { background: var(--black); }

        .field { margin-bottom: 1.25rem; }

        .btn {
            display: block;
            width: 100%;
            padding: 0.85rem 1.5rem;
            background: var(--accent);
            color: var(--white);
            border: none;
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
            text-transform: uppercase;
        }

        .btn:hover { background: #e03d00; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        .btn-ghost {
            background: transparent;
            border: 1px solid #333;
            color: var(--white);
        }
        .btn-ghost:hover { background: #222; border-color: #555; }

        .btn-sm {
            display: inline-block;
            width: auto;
            padding: 0.4rem 0.9rem;
            font-size: 0.75rem;
        }

        .btn-danger { background: var(--red); }
        .btn-danger:hover { background: #cc1133; }

        .btn-success { background: #007744; }
        .btn-success:hover { background: #005533; }

        .error-msg {
            background: rgba(255,34,68,0.1);
            border: 1px solid rgba(255,34,68,0.3);
            color: var(--red);
            padding: 0.75rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            margin-top: 1rem;
            display: none;
        }
        .error-msg.show { display: block; }

        /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
        #app { display: none; }
        #app.visible { display: block; }

        .app-header {
            background: var(--gray);
            border-bottom: 1px solid #1e1e1e;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-chip {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--muted);
        }
        .user-chip strong { color: var(--accent2); }

        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            padding: 0 1.5rem;
            background: var(--gray);
            border-bottom: 1px solid #1e1e1e;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 0.85rem 1.25rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--muted);
            font-family: 'Syne', sans-serif;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover { color: var(--white); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .content { padding: 1.5rem; max-width: 1100px; margin: 0 auto; }

        /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
        .panel {
            background: var(--gray);
            border: 1px solid #1e1e1e;
            padding: 1.75rem;
            margin-bottom: 1.25rem;
            animation: fadeIn 0.25s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .panel-title .accent-dot {
            width: 8px; height: 8px;
            background: var(--accent);
            border-radius: 50%;
            display: inline-block;
        }

        /* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #1e1e1e;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            background: var(--gray2);
            padding: 1rem 1.25rem;
            text-align: center;
        }

        .stat-num {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'Space Mono', monospace;
            line-height: 1;
        }

        .stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--muted);
            margin-top: 0.3rem;
        }

        .stat-total .stat-num  { color: var(--accent2); }
        .stat-used .stat-num   { color: var(--red); }
        .stat-avail .stat-num  { color: var(--green); }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .table-wrap { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        thead tr { border-bottom: 2px solid #2a2a2a; }

        th {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--muted);
            padding: 0.6rem 0.75rem;
            text-align: left;
        }

        td {
            padding: 0.75rem;
            font-size: 0.85rem;
            border-bottom: 1px solid #1a1a1a;
        }

        tr:hover td { background: rgba(255,255,255,0.02); }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            letter-spacing: 0.06em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-org { background: rgba(0,229,255,0.15); color: var(--accent2); }
        .badge-guard { background: rgba(0,255,136,0.12); color: var(--green); }
        .badge-used { background: rgba(255,34,68,0.15); color: var(--red); }
        .badge-avail { background: rgba(0,255,136,0.12); color: var(--green); }

        /* ‚îÄ‚îÄ TICKETS GRID ‚îÄ‚îÄ */
        .tickets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1rem;
        }

        .ticket-card {
            background: var(--black);
            border: 1px solid #222;
            padding: 1.25rem;
            animation: fadeIn 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ticket-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
        }

        .ticket-card.avail::before { background: var(--green); }
        .ticket-card.used::before  { background: var(--red); }

        .ticket-evento {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ticket-meta {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--muted);
            margin-bottom: 1rem;
        }

        .ticket-qr {
            background: white;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
        }

        .ticket-id {
            font-family: 'Space Mono', monospace;
            font-size: 0.55rem;
            color: var(--muted);
            word-break: break-all;
            margin-bottom: 0.75rem;
        }

        .ticket-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* ‚îÄ‚îÄ VERIFY PANEL ‚îÄ‚îÄ */
        .mode-switcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: #1a1a1a;
            margin-bottom: 1.5rem;
        }

        .mode-btn {
            padding: 0.75rem;
            background: var(--black);
            border: none;
            color: var(--muted);
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--accent);
            color: var(--white);
        }

        .result-box {
            padding: 1.5rem;
            border: 2px solid;
            animation: fadeIn 0.2s ease;
        }

        .result-valid   { border-color: var(--green); background: rgba(0,255,136,0.05); }
        .result-used    { border-color: var(--yellow); background: rgba(255,230,0,0.05); }
        .result-invalid { border-color: var(--red); background: rgba(255,34,68,0.05); }

        .result-title {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 0.4rem;
        }

        .result-desc {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--muted);
        }

        .result-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #2a2a2a;
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            line-height: 1.8;
        }

        .result-info strong { color: var(--white); }

        /* ‚îÄ‚îÄ QR SCANNER ‚îÄ‚îÄ */
        #qr-reader { width: 100%; max-width: 480px; margin: 0 auto; }
        #qr-reader video { border-radius: 0 !important; }

        /* ‚îÄ‚îÄ DANGER ZONE ‚îÄ‚îÄ */
        .danger-zone {
            border: 1px solid rgba(255,34,68,0.25);
            background: rgba(255,34,68,0.04);
            padding: 1.25rem;
        }

        .danger-title {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--red);
            margin-bottom: 1rem;
        }

        /* ‚îÄ‚îÄ FIREBASE STATUS ‚îÄ‚îÄ */
        .firebase-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--gray2);
            border: 1px solid #2a2a2a;
            padding: 0.5rem 0.85rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            z-index: 9000;
        }

        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--muted);
        }
        .status-dot.online  { background: var(--green); animation: pulse 2s infinite; }
        .status-dot.offline { background: var(--red); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.3; }
        }

        /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
        .loading {
            text-align: center;
            padding: 3rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--muted);
            letter-spacing: 0.1em;
        }

        .spinner {
            width: 24px; height: 24px;
            border: 2px solid #222;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ */
        .hidden { display: none !important; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .empty-state {
            text-align: center;
            padding: 3rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--muted);
            letter-spacing: 0.08em;
        }

        .setup-overlay {
            position: fixed;
            inset: 0;
            background: var(--black);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .setup-box {
            width: 100%;
            max-width: 500px;
            background: var(--gray);
            border: 1px solid #2a2a2a;
            padding: 2rem;
            border-top: 3px solid var(--accent2);
        }

        .setup-box h2 {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .setup-box p {
            font-family: 'Space Mono', monospace;
            font-size: 0.72rem;
            color: var(--muted);
            line-height: 1.7;
            margin-bottom: 1.25rem;
        }

        .code-block {
            background: var(--black);
            border: 1px solid #2a2a2a;
            padding: 0.75rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--accent2);
            margin-bottom: 1rem;
            word-break: break-all;
            line-height: 1.6;
        }

        @media (max-width: 640px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .stats-bar { grid-template-columns: repeat(3, 1fr); }
            .stat-num { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

<!-- ‚ñà‚ñà FIREBASE CONFIG OVERLAY ‚ñà‚ñà -->
<div id="setup-overlay" class="setup-overlay hidden">
    <div class="setup-box">
        <h2>‚ö° Configurar Firebase</h2>
        <p>Pega aqu√≠ la configuraci√≥n de tu proyecto Firebase.<br>
        Ve a Firebase Console ‚Üí Tu proyecto ‚Üí Configuraci√≥n ‚Üí Config de la app web.</p>
        <div class="field">
            <label>Firebase Config (JSON)</label>
            <textarea id="firebase-config-input" rows="8"
                style="width:100%;background:#000;border:1px solid #333;color:#00e5ff;padding:0.75rem;font-family:'Space Mono',monospace;font-size:0.7rem;resize:vertical;outline:none;"
                placeholder='{
  "apiKey": "AIza...",
  "authDomain": "tu-proyecto.firebaseapp.com",
  "databaseURL": "https://tu-proyecto-default-rtdb.firebaseio.com",
  "projectId": "tu-proyecto",
  "storageBucket": "tu-proyecto.appspot.com",
  "messagingSenderId": "123456",
  "appId": "1:123456:web:abc123"
}'></textarea>
        </div>
        <button class="btn" onclick="guardarConfigFirebase()">Guardar y Conectar</button>
        <div id="setup-error" class="error-msg mt-1"></div>
    </div>
</div>

<!-- ‚ñà‚ñà LOGIN ‚ñà‚ñà -->
<div id="pantalla-login" class="hidden">
    <div class="login-box">
        <div class="logo-mark">
            <div class="logo-icon">üéü</div>
            <div>
                <div class="logo-text">Ticketon</div>
                <div class="logo-sub">Sistema de Tickets QR</div>
            </div>
        </div>

        <div class="field">
            <label>Usuario</label>
            <input type="text" id="login-usuario" placeholder="tu_usuario" autocomplete="username">
        </div>

        <div class="field">
            <label>Contrase√±a</label>
            <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                onkeypress="if(event.key==='Enter') iniciarSesion()" autocomplete="current-password">
        </div>

        <button class="btn" onclick="iniciarSesion()">Iniciar Sesi√≥n ‚Üí</button>
        <div id="error-login" class="error-msg">Usuario o contrase√±a incorrectos</div>
    </div>
</div>

<!-- ‚ñà‚ñà APP ‚ñà‚ñà -->
<div id="app">
    <header class="app-header">
        <div class="header-brand">
            <div class="logo-icon" style="width:32px;height:32px;font-size:1rem;">üéü</div>
            <div>
                <div style="font-weight:800;font-size:1.1rem;letter-spacing:-0.02em;">Ticketon</div>
                <div class="user-chip"><strong id="usuario-actual"></strong> / <span id="rol-actual"></span></div>
            </div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
    </header>

    <nav class="nav-tabs" id="menu-navegacion"></nav>

    <main class="content">
        <!-- VISTA: Admin Usuarios -->
        <div id="vista-admin-usuarios" class="hidden">
            <div class="panel">
                <div class="panel-title"><span class="accent-dot"></span> Crear Usuario</div>
                <div class="grid-3">
                    <div class="field"><label>Usuario</label>
                        <input type="text" id="nuevo-usuario" placeholder="nombre_usuario">
                    </div>
                    <div class="field"><label>Contrase√±a</label>
                        <input type="password" id="nuevo-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="field"><label>Rol</label>
                        <select id="nuevo-rol">
                            <option value="organizador">Organizador</option>
                            <option value="guardia">Guardia</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="crearUsuario()">Crear Usuario</button>
            </div>

            <div class="panel">
                <div class="panel-title"><span class="accent-dot"></span> Usuarios del Sistema</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Rol</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="lista-usuarios"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VISTA: Generar Tickets -->
        <div id="vista-generar" class="hidden">
            <div class="stats-bar" id="stats-bar-gen">
                <div class="stat-item stat-total">
                    <div class="stat-num" id="stat-total">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item stat-used">
                    <div class="stat-num" id="stat-used">0</div>
                    <div class="stat-label">Usados</div>
                </div>
                <div class="stat-item stat-avail">
                    <div class="stat-num" id="stat-avail">0</div>
                    <div class="stat-label">Disponibles</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title"><span class="accent-dot"></span> Nuevo Lote de Tickets</div>
                <div class="grid-2">
                    <div class="field"><label>Nombre del Evento</label>
                        <input type="text" id="nombre-evento" placeholder="Ej: Concierto de Rock">
                    </div>
                    <div class="field"><label>Cantidad (1‚Äì500)</label>
                        <input type="number" id="cantidad-tickets" min="1" max="500" value="1">
                    </div>
                </div>
                <button class="btn" onclick="generarTickets()">Generar Tickets</button>
            </div>

            <div class="danger-zone">
                <div class="danger-title">‚ö† Zona de Peligro</div>
                <div class="grid-2">
                    <button class="btn btn-danger" onclick="resetearTickets()">Eliminar Todos los Tickets</button>
                    <button class="btn btn-danger" onclick="resetearSistemaCompleto()" style="background:#770011;">Resetear Sistema Completo</button>
                </div>
            </div>
        </div>

        <!-- VISTA: Verificar -->
        <div id="vista-verificar" class="hidden">
            <div class="panel">
                <div class="panel-title"><span class="accent-dot"></span> Verificar Ticket</div>

                <div class="mode-switcher">
                    <button class="mode-btn active" id="btn-modo-manual" onclick="cambiarModoVerificacion('manual')">Ingresar C√≥digo</button>
                    <button class="mode-btn" id="btn-modo-escanear" onclick="cambiarModoVerificacion('escanear')">Escanear QR</button>
                </div>

                <div id="modo-manual">
                    <div class="field">
                        <label>C√≥digo del Ticket</label>
                        <input type="text" id="codigo-verificar" placeholder="TKT-XXXXXXXXX"
                            style="font-family:'Space Mono',monospace;text-transform:uppercase;"
                            onkeypress="if(event.key==='Enter') verificarTicket()">
                    </div>
                    <button class="btn" onclick="verificarTicket()">Verificar ‚Üí</button>
                </div>

                <div id="modo-escanear" class="hidden">
                    <div style="background:#000;padding:1rem;text-align:center;">
                        <div id="qr-reader"></div>
                        <p style="font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--muted);margin-top:0.75rem;">
                            Apunta la c√°mara al c√≥digo QR
                        </p>
                    </div>
                    <button class="btn btn-danger mt-2" onclick="detenerEscaneo()">Detener C√°mara</button>
                </div>

                <div id="resultado-verificacion" class="mt-3 hidden"></div>
            </div>
        </div>

        <!-- VISTA: Lista -->
        <div id="vista-lista" class="hidden">
            <div class="stats-bar" style="margin-bottom:1.25rem;">
                <div class="stat-item stat-total">
                    <div class="stat-num" id="stat-total-lista">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item stat-used">
                    <div class="stat-num" id="stat-used-lista">0</div>
                    <div class="stat-label">Usados</div>
                </div>
                <div class="stat-item stat-avail">
                    <div class="stat-num" id="stat-avail-lista">0</div>
                    <div class="stat-label">Disponibles</div>
                </div>
            </div>
            <div id="contenedor-tickets" class="tickets-grid"></div>
        </div>
    </main>
</div>

<!-- ‚ñà‚ñà FIREBASE STATUS ‚ñà‚ñà -->
<div class="firebase-status">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-text" style="text-transform:uppercase;letter-spacing:0.1em;">desconectado</span>
</div>

<!-- ‚ñà‚ñà LIBS ‚ñà‚ñà -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Firebase SDK (compat v9) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ESTADO GLOBAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let db = null;
let tickets = {};          // { id: ticketObj }
let ticketsUsados = {};    // { id: true }
let usuarios = {};         // { key: userObj }
let usuarioActual = null;
let rolActual = null;
let vistaActual = null;
let modoVerificacion = 'manual';
let html5QrcodeScanner = null;
let unsubscribeTickets = null;
let unsubscribeUsados   = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function inicializarFirebase(config) {
    try {
        if (firebase.apps.length) firebase.apps[0].delete();
        firebase.initializeApp(config);
        db = firebase.database();

        // Verificar conexi√≥n
        db.ref('.info/connected').on('value', snap => {
            const online = snap.val();
            document.getElementById('status-dot').className = 'status-dot ' + (online ? 'online' : 'offline');
            document.getElementById('status-text').textContent = online ? 'SINCRONIZADO' : 'SIN CONEXI√ìN';
        });

        return true;
    } catch(e) {
        console.error(e);
        return false;
    }
}

function guardarConfigFirebase() {
    const raw = document.getElementById('firebase-config-input').value.trim();
    const errEl = document.getElementById('setup-error');
    errEl.classList.remove('show');

    let config;
    try {
        config = JSON.parse(raw);
    } catch(e) {
        errEl.textContent = 'JSON inv√°lido. Revisa que sea exactamente como lo da Firebase.';
        errEl.classList.add('show');
        return;
    }

    if (!config.databaseURL) {
        errEl.textContent = 'Falta "databaseURL". Aseg√∫rate de activar Realtime Database en Firebase.';
        errEl.classList.add('show');
        return;
    }

    const ok = inicializarFirebase(config);
    if (!ok) {
        errEl.textContent = 'Error al conectar. Verifica tu configuraci√≥n.';
        errEl.classList.add('show');
        return;
    }

    localStorage.setItem('firebase-config', JSON.stringify(config));
    document.getElementById('setup-overlay').classList.add('hidden');
    mostrarLogin();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INICIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', function() {
    const cfg = localStorage.getItem('firebase-config');
    if (cfg) {
        const config = JSON.parse(cfg);
        const ok = inicializarFirebase(config);
        if (ok) {
            mostrarLogin();
            verificarSesion();
            return;
        }
    }
    document.getElementById('setup-overlay').classList.remove('hidden');
});

function mostrarLogin() {
    document.getElementById('setup-overlay').classList.add('hidden');
    document.getElementById('pantalla-login').classList.remove('hidden');
    document.getElementById('app').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SESI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function verificarSesion() {
    const sesion = sessionStorage.getItem('sesion');
    if (sesion) {
        const d = JSON.parse(sesion);
        usuarioActual = d.usuario;
        rolActual = d.rol;
        mostrarPanel();
    }
}

function iniciarSesion() {
    if (!db) { alert('Firebase no conectado'); return; }

    const usr = document.getElementById('login-usuario').value.trim();
    const pwd = document.getElementById('login-password').value;
    const errEl = document.getElementById('error-login');
    errEl.classList.remove('show');

    // Admin hardcoded (puedes cambiar)
    const admins = [{ usuario: 'leon', password: 'benitez01', rol: 'admin' }];
    const admin = admins.find(a => a.usuario === usr && a.password === pwd);
    if (admin) {
        loginExitoso(admin.usuario, admin.rol);
        return;
    }

    // Buscar en Firebase
    db.ref('usuarios').once('value').then(snap => {
        const data = snap.val() || {};
        const found = Object.values(data).find(u => u.usuario === usr && u.password === pwd);
        if (found) {
            loginExitoso(found.usuario, found.rol);
        } else {
            errEl.classList.add('show');
        }
    }).catch(() => errEl.classList.add('show'));
}

function loginExitoso(usuario, rol) {
    usuarioActual = usuario;
    rolActual = rol;
    sessionStorage.setItem('sesion', JSON.stringify({ usuario, rol }));
    mostrarPanel();
}

function cerrarSesion() {
    sessionStorage.removeItem('sesion');
    detenerListeners();
    detenerEscaneo();
    usuarioActual = null;
    rolActual = null;
    document.getElementById('app').style.display = 'none';
    document.getElementById('pantalla-login').classList.remove('hidden');
    document.getElementById('login-usuario').value = '';
    document.getElementById('login-password').value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mostrarPanel() {
    document.getElementById('pantalla-login').classList.add('hidden');
    document.getElementById('app').style.display = 'block';
    document.getElementById('usuario-actual').textContent = usuarioActual;

    const menu = document.getElementById('menu-navegacion');
    menu.innerHTML = '';

    const tabs = [];

    if (rolActual === 'admin') {
        document.getElementById('rol-actual').textContent = 'Administrador';
        tabs.push({ id: 'admin-usuarios', label: 'Usuarios' });
        tabs.push({ id: 'generar',        label: 'Generar' });
        tabs.push({ id: 'verificar',      label: 'Verificar' });
        tabs.push({ id: 'lista',          label: 'Lista' });
    } else if (rolActual === 'organizador') {
        document.getElementById('rol-actual').textContent = 'Organizador';
        tabs.push({ id: 'verificar', label: 'Verificar' });
        tabs.push({ id: 'lista',     label: 'Lista' });
    } else {
        document.getElementById('rol-actual').textContent = 'Guardia';
        tabs.push({ id: 'verificar', label: 'Verificar Tickets' });
    }

    tabs.forEach(t => {
        const btn = document.createElement('button');
        btn.className = 'nav-tab';
        btn.id = 'btn-' + t.id;
        btn.textContent = t.label;
        btn.onclick = () => cambiarVista(t.id);
        menu.appendChild(btn);
    });

    iniciarListeners();
    cambiarVista(tabs[0].id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LISTENERS FIREBASE TIEMPO REAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function iniciarListeners() {
    detenerListeners();

    unsubscribeTickets = db.ref('tickets').on('value', snap => {
        tickets = snap.val() || {};
        actualizarEstadisticas();
        if (vistaActual === 'lista') mostrarListaTickets();
    });

    unsubscribeUsados = db.ref('tickets-usados').on('value', snap => {
        ticketsUsados = snap.val() || {};
        actualizarEstadisticas();
        if (vistaActual === 'lista') mostrarListaTickets();
    });

    db.ref('usuarios').on('value', snap => {
        usuarios = snap.val() || {};
        if (vistaActual === 'admin-usuarios') actualizarListaUsuarios();
    });
}

function detenerListeners() {
    if (db) {
        try { db.ref('tickets').off(); } catch(e) {}
        try { db.ref('tickets-usados').off(); } catch(e) {}
        try { db.ref('usuarios').off(); } catch(e) {}
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USUARIOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function crearUsuario() {
    const usuario  = document.getElementById('nuevo-usuario').value.trim();
    const password = document.getElementById('nuevo-password').value;
    const rol      = document.getElementById('nuevo-rol').value;

    if (!usuario || !password) { alert('Completa todos los campos'); return; }

    const existe = Object.values(usuarios).some(u => u.usuario === usuario);
    if (existe) { alert('El usuario ya existe'); return; }

    db.ref('usuarios').push({ usuario, password, rol })
        .then(() => {
            document.getElementById('nuevo-usuario').value = '';
            document.getElementById('nuevo-password').value = '';
            alert('Usuario creado ‚úì');
        })
        .catch(e => alert('Error: ' + e.message));
}

function eliminarUsuario(key, nombre) {
    if (nombre === 'leon') { alert('No puedes eliminar al admin principal'); return; }
    if (!confirm('¬øEliminar usuario "' + nombre + '"?')) return;
    db.ref('usuarios/' + key).remove();
}

function actualizarListaUsuarios() {
    const tbody = document.getElementById('lista-usuarios');
    tbody.innerHTML = '';

    const lista = Object.entries(usuarios);
    if (lista.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--muted);font-size:0.8rem;padding:1.5rem;">Sin usuarios creados</td></tr>';
        return;
    }

    lista.forEach(([key, u]) => {
        if (u.rol === 'admin') return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-family:'Space Mono',monospace;font-size:0.8rem;">${u.usuario}</td>
            <td><span class="badge ${u.rol === 'organizador' ? 'badge-org' : 'badge-guard'}">
                ${u.rol === 'organizador' ? 'Organizador' : 'Guardia'}
            </span></td>
            <td><button class="btn btn-danger btn-sm" onclick="eliminarUsuario('${key}','${u.usuario}')">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TICKETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generarCodigo() {
    const ts = Date.now();
    const r  = Math.random().toString(36).substr(2, 9).toUpperCase();
    return 'TKT-' + ts + '-' + r;
}

function generarTickets() {
    if (rolActual !== 'admin') { alert('Solo administradores'); return; }

    const evento   = document.getElementById('nombre-evento').value.trim();
    const cantidad = parseInt(document.getElementById('cantidad-tickets').value);

    if (!evento)                  { alert('Ingresa el nombre del evento'); return; }
    if (cantidad < 1 || cantidad > 500) { alert('Cantidad entre 1 y 500'); return; }

    const total   = Object.keys(tickets).length;
    const updates = {};

    for (let i = 0; i < cantidad; i++) {
        const codigo = generarCodigo();
        updates[codigo] = {
            id: codigo,
            evento,
            fecha: new Date().toLocaleString('es-MX'),
            numero: total + i + 1,
            creador: usuarioActual
        };
    }

    db.ref('tickets').update(updates)
        .then(() => alert('‚úì ' + cantidad + ' ticket(s) generados'))
        .catch(e => alert('Error: ' + e.message));
}

function resetearTickets() {
    if (rolActual !== 'admin') return;
    const total = Object.keys(tickets).length;
    if (!confirm('¬øEliminar los ' + total + ' tickets? Esta acci√≥n no se puede deshacer.')) return;
    if (!confirm('CONFIRMACI√ìN FINAL: ¬øContinuar?')) return;

    Promise.all([
        db.ref('tickets').remove(),
        db.ref('tickets-usados').remove()
    ]).then(() => alert('Tickets eliminados ‚úì'))
      .catch(e => alert('Error: ' + e.message));
}

function resetearSistemaCompleto() {
    if (rolActual !== 'admin') return;
    if (!confirm('‚ö†Ô∏è Esto eliminar√° TICKETS + USUARIOS (excepto admin). ¬øSeguro?')) return;
    if (!confirm('√öLTIMA CONFIRMACI√ìN. ¬øResetear todo?')) return;

    Promise.all([
        db.ref('tickets').remove(),
        db.ref('tickets-usados').remove(),
        db.ref('usuarios').remove()
    ]).then(() => alert('Sistema reseteado ‚úì'))
      .catch(e => alert('Error: ' + e.message));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VERIFICACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function verificarTicket() {
    const codigo = document.getElementById('codigo-verificar').value.trim().toUpperCase();
    if (!codigo) { mostrarResultado('invalid', 'Ingresa un c√≥digo', ''); return; }
    procesarVerificacion(codigo);
}

function verificarTicketEscaneado(codigo) {
    detenerEscaneo();
    procesarVerificacion(codigo.trim().toUpperCase());
    setTimeout(() => { if (modoVerificacion === 'escanear') iniciarEscaneo(); }, 3500);
}

function procesarVerificacion(codigo) {
    const ticket = tickets[codigo];

    if (!ticket) {
        mostrarResultado('invalid', '‚ùå Ticket No Existe', 'Este c√≥digo no est√° registrado.');
        return;
    }

    if (ticketsUsados[codigo]) {
        mostrarResultado('used', '‚ö†Ô∏è Ticket Ya Utilizado', 'Este ticket ya fue escaneado.', ticket);
        return;
    }

    // Marcar como usado en Firebase
    db.ref('tickets-usados/' + codigo).set(true)
        .then(() => mostrarResultado('valid', '‚úÖ Acceso Permitido', 'Ticket v√°lido.', ticket))
        .catch(e => mostrarResultado('invalid', 'Error de red', e.message));
}

function mostrarResultado(tipo, titulo, desc, ticket) {
    const el = document.getElementById('resultado-verificacion');
    el.classList.remove('hidden');

    const clsMap = { valid: 'result-valid', used: 'result-used', invalid: 'result-invalid' };
    const cls = clsMap[tipo] || 'result-invalid';

    let info = '';
    if (ticket) {
        info = `<div class="result-info">
            <div><strong>Evento:</strong> ${ticket.evento}</div>
            <div><strong>Ticket #:</strong> ${ticket.numero}</div>
            <div><strong>Emitido:</strong> ${ticket.fecha}</div>
        </div>`;
    }

    el.innerHTML = `<div class="result-box ${cls}">
        <div class="result-title">${titulo}</div>
        <div class="result-desc">${desc}</div>
        ${info}
    </div>`;
}

function cambiarModoVerificacion(modo) {
    modoVerificacion = modo;

    document.getElementById('btn-modo-manual').classList.toggle('active',   modo === 'manual');
    document.getElementById('btn-modo-escanear').classList.toggle('active', modo === 'escanear');

    if (modo === 'manual') {
        document.getElementById('modo-manual').classList.remove('hidden');
        document.getElementById('modo-escanear').classList.add('hidden');
        detenerEscaneo();
    } else {
        document.getElementById('modo-manual').classList.add('hidden');
        document.getElementById('modo-escanear').classList.remove('hidden');
        iniciarEscaneo();
    }
}

function iniciarEscaneo() {
    if (html5QrcodeScanner) return;
    html5QrcodeScanner = new Html5Qrcode('qr-reader');
    html5QrcodeScanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 260, height: 260 } },
        text => verificarTicketEscaneado(text),
        () => {}
    ).catch(err => {
        console.error(err);
        alert('No se pudo acceder a la c√°mara.');
        html5QrcodeScanner = null;
    });
}

function detenerEscaneo() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.stop().then(() => { html5QrcodeScanner = null; }).catch(() => { html5QrcodeScanner = null; });
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LISTA DE TICKETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mostrarListaTickets() {
    const contenedor = document.getElementById('contenedor-tickets');
    const lista = Object.values(tickets);

    actualizarEstadisticasLista();

    if (lista.length === 0) {
        contenedor.innerHTML = '<div class="empty-state" style="grid-column:1/-1;">SIN TICKETS GENERADOS</div>';
        return;
    }

    let html = '';
    lista.forEach(ticket => {
        const usado = !!ticketsUsados[ticket.id];
        const qrId  = 'qr-' + ticket.id.replace(/[^a-zA-Z0-9]/g, '');

        html += `
        <div class="ticket-card ${usado ? 'used' : 'avail'}">
            <div class="ticket-evento">${ticket.evento}</div>
            <div class="ticket-meta">Ticket #${ticket.numero} ¬∑ ${ticket.fecha}</div>
            <div class="ticket-qr"><div id="${qrId}"></div></div>
            <div class="ticket-id">${ticket.id}</div>
            <div class="ticket-footer">
                <span class="badge ${usado ? 'badge-used' : 'badge-avail'}">${usado ? 'USADO' : 'DISPONIBLE'}</span>
                <button class="btn btn-sm" onclick="descargarTicket('${ticket.id}')" style="padding:0.35rem 0.7rem;font-size:0.68rem;">Descargar</button>
            </div>
        </div>`;
    });

    contenedor.innerHTML = html;

    setTimeout(() => {
        lista.forEach(ticket => {
            const qrId  = 'qr-' + ticket.id.replace(/[^a-zA-Z0-9]/g, '');
            const el    = document.getElementById(qrId);
            if (el && el.innerHTML === '') {
                new QRCode(el, { text: ticket.id, width: 130, height: 130,
                    colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
            }
        });
    }, 80);
}

function descargarTicket(ticketId) {
    const ticket = tickets[ticketId];
    if (!ticket) return;

    const qrId = 'qr-' + ticketId.replace(/[^a-zA-Z0-9]/g, '');
    const qrEl = document.getElementById(qrId);
    const qrImg = qrEl ? qrEl.querySelector('img') : null;
    if (!qrImg) { alert('QR no generado a√∫n'); return; }

    const canvas = document.createElement('canvas');
    canvas.width  = 400;
    canvas.height = 520;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, 400, 520);

    ctx.fillStyle = '#ff4d00';
    ctx.fillRect(0, 0, 400, 4);

    ctx.fillStyle = '#f5f0e8';
    ctx.font = 'bold 22px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(ticket.evento, 200, 40);

    ctx.fillStyle = '#888';
    ctx.font = '13px monospace';
    ctx.fillText('TICKET #' + ticket.numero + '  ¬∑  ' + ticket.fecha, 200, 65);

    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(50, 90, 300, 300);
        ctx.drawImage(img, 60, 100, 280, 280);

        ctx.fillStyle = '#555';
        ctx.font      = '10px monospace';
        ctx.fillText(ticket.id, 200, 420);

        ctx.fillStyle = '#f5f0e8';
        ctx.font = 'bold 16px Arial';
        ctx.fillText('TICKETON', 200, 460);

        const link = document.createElement('a');
        link.download = 'ticket-' + ticket.numero + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    };
    img.src = qrImg.src;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ESTAD√çSTICAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function actualizarEstadisticas() {
    const total = Object.keys(tickets).length;
    const used  = Object.keys(ticketsUsados).length;
    const avail = total - used;

    ['stat-total','stat-used','stat-avail'].forEach((id, i) => {
        const el = document.getElementById(id);
        if (el) el.textContent = [total, used, avail][i];
    });
}

function actualizarEstadisticasLista() {
    const total = Object.keys(tickets).length;
    const used  = Object.keys(ticketsUsados).length;
    const avail = total - used;

    const tl = document.getElementById('stat-total-lista');
    const ul = document.getElementById('stat-used-lista');
    const al = document.getElementById('stat-avail-lista');
    if (tl) tl.textContent = total;
    if (ul) ul.textContent = used;
    if (al) al.textContent = avail;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVEGACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cambiarVista(vista) {
    if (vistaActual === 'verificar') detenerEscaneo();
    vistaActual = vista;

    ['admin-usuarios','generar','verificar','lista'].forEach(v => {
        document.getElementById('vista-' + v).classList.add('hidden');
    });

    document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));

    document.getElementById('vista-' + vista).classList.remove('hidden');
    const btn = document.getElementById('btn-' + vista);
    if (btn) btn.classList.add('active');

    if (vista === 'lista')          mostrarListaTickets();
    if (vista === 'admin-usuarios') actualizarListaUsuarios();
    if (vista === 'generar')        actualizarEstadisticas();

    document.getElementById('resultado-verificacion')?.classList.add('hidden');
}
</script>
</body>
</html>
